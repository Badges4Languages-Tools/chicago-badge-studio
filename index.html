<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.css">
<style>
body {
  margin-bottom: 10px;
}

.affix {
  top: 10px;
}

input.color {
  border: none;
  padding: 3px;
  margin-bottom: 10px;
}

.radio-details {
  padding-left: 20px;
}
</style>
<title>Chicago Badge Studio</title>
<a href="https://github.com/toolness/chicago-badge-studio"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
<div class="container">
  <h1>Chicago Badge Studio</h1>
  <p>Design your badge image for the <a href="http://chicagosummeroflearning.org/">Chicago Summer of Learning</a> below.</p>
  <div class="row">
    <div class="span4">
      <form>
        <fieldset>
          <h4>Background</h4>
          <label class="radio">
            <input type="radio" name="bg" id="bg1" value="color" data-validator="radio" checked> Color
          </label>
          <div class="radio-details">
            <input id="bg-color" class="color" value="9E300E" data-validator="color">
          </div>
          <label class="radio">
            <input type="radio" name="bg" id="bg2" value="subtlepattern"> Subtle Pattern
          </label>
          <div class="radio-details">
            <select id="bg-subtlepattern" data-validator="select"></select>
            <p class="muted"><small>Subtle Patterns are courtesy <a href="http://subtlepatterns.com/">subtlepatterns.com</a>, and are licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC BY-SA 3.0</a> license.</small></p>
          </div>
          <label class="radio">
            <input type="radio" name="bg" id="bg3" value="url"> Custom image URL
          </label>
          <div class="radio-details">
            <input id="bg-url" type="text" data-validator="url" placeholder="http://">
          </div>
          <h4>Glyph</h4>
          <label class="radio">
            <input type="radio" name="glyph" id="glyph1" value="none" data-validator="radio" checked> No glyph
          </label>
          <label class="radio">
            <input type="radio" name="glyph" id="glyph2" value="noun"> Noun
          </label>
          <div class="radio-details">
            <select id="glyph-noun" data-validator="select"></select>
            <p class="muted"><small>Nouns are courtesy <a href="http://nounproject.com/">nounproject.com</a>. Each noun has its own Creative Commons license.</small></p>
          </div>
          <label class="radio">
            <input type="radio" name="glyph" id="glyph3" value="url"> Custom image URL
          </label>
          <div class="radio-details">
            <input id="glyph-url" type="text" data-validator="url" placeholder="http://">
          </div>
          <label>Scaling</label>
          <input id="glyph-scale" type="text" value="1.0" data-validator="float">
          <label class="checkbox">
            <input id="glyph-mask" type="checkbox" data-validator="boolean" checked> Apply mask color
          </label>
          <input id="glyph-mask-color" class="color" value="000000" data-validator="color">
          <h4>Other Options</h4>
          <label class="checkbox">
            <input id="gloss" type="checkbox" data-validator="boolean" checked> Glossy
          </label>
        </fieldset>
      </form>
      <a id="badge-link" class="btn btn-primary btn-block">Link to this badge</a>
      <button id="export-button" class="btn btn-block">Export badge image</button>
      <hr>
      <p class="muted"><small>When sharing or publishing your badge, please credit <a href="https://twitter.com/iamjessklein">Jessica Klein</a> for the <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a> badge ribbon, as well as any other additional sources that you draw from.</small></p>
    </div>
    <div class="span8">
      <div id="badge-holder">
        <p class="muted">Loading&hellip;</p>
      </div>
    </div>
  </div>
</div>
<script src="vendor/jquery.js"></script>
<script>
function addFilenamesAsOptions(url, selectElement) {
  return $.get(url, function(textFile) {
    textFile.split('\n').forEach(function(filename) {
      if (!filename) return;
      $('<option></option>')
        .text(filename.split('.')[0].replace(/[_-]/g, ' '))
        .attr("value", filename)
        .appendTo(selectElement);
    });
  });
}

var deferredRequests = $.when(
  addFilenamesAsOptions("vendor/subtlepatterns.txt", "#bg-subtlepattern"),
  addFilenamesAsOptions("vendor/nounproject.txt", "#glyph-noun")
);
</script>
<script src="vendor/jscolor/jscolor.js"></script>
<script src="vendor/bootstrap/js/bootstrap.js"></script>
<script src="chibadge/chibadge.js"></script>
<script src="validation.js"></script>
<script>
var BASE_SUBTLEPATTERN_URL = 'http://subtlepatterns.toolness.org/';
var BASE_NOUN_URL = 'http://nounproject.toolness.org/';

// Based on http://stackoverflow.com/a/647272.
function queryObj() {
  var result = {}, keyValuePairs = location.search.slice(1).split('&');

  keyValuePairs.forEach(function(kvp) {
    kvp = kvp.split('=');
    result[decodeURIComponent(kvp[0])] = decodeURIComponent(kvp[1] || '');
  });

  return result;
}

function img(src) {
  var img = document.createElement("img");
  img.setAttribute("src", src);
  return img;
}

function startStateManager(options) {
  var onChange = options.onChange || function() {};
  var latestState = $.extend(Validation.getState(), queryObj());
  var setState = function(newState, noPushState) {
    if (Validation.areStatesSame(newState, latestState)) return;
    latestState = newState;
    Validation.setState(newState);
    if (window.history.pushState && !noPushState)
      window.history.pushState(newState, "", "?" + $.param(newState));
    onChange(newState);
  };

  $(document.body).on("change", "input, select", function() {
    setState(Validation.getState());
  });

  $(window).on("popstate", function(event) {
    setState(event.originalEvent.state, true);
  });

  Validation.setState(latestState);
  if (window.history.replaceState)
    window.history.replaceState(latestState, "", null);
  onChange(latestState);
}

// We used to only wait for the DOM to be ready, but JSColor widgets don't
// seem to be active until the page is fully loaded.
$(window).load(function() {
  var renderIdCounter = 0;
  var badgeHolder = $("#badge-holder");
  var bgColor = $("#bg-color");
  var bgSubtlepattern = $("#bg-subtlepattern");
  var bgUrl = $("#bg-url");
  var glyphNoun = $("#glyph-noun");
  var glyphUrl = $("#glyph-url");
  var glyphScale = $("#glyph-scale");
  var glyphMask = $("#glyph-mask");
  var glyphMaskColor = $("#glyph-mask-color");
  var gloss = $("#gloss");
  var badgeLink = $("#badge-link");
  var exportButton = $("#export-button");
  var badgeSize = badgeHolder.width() - 20;
  var origBadgeHolderTop = badgeHolder.offset().top;
  var renderBadge = function() {
    var renderId = ++renderIdCounter;
    var backgroundRadioHandlers = {
      'color': function() { return '#' + bgColor.val(); },
      'subtlepattern': function() {
        return img(BASE_SUBTLEPATTERN_URL + bgSubtlepattern.val());
      },
      'url': function() {
        if (Validation.isSafeUrl(bgUrl.val())) return img(bgUrl.val());
      }
    };
    var glyphRadioHandlers = {
      'none': function() {},
      'noun': function() { return img(BASE_NOUN_URL + glyphNoun.val()) },
      'url': function() {
        if (Validation.isSafeUrl(glyphUrl.val())) return img(glyphUrl.val());
      }
    };
    var background = backgroundRadioHandlers[Validation.radioValue("bg")]();
    var glyph = glyphRadioHandlers[Validation.radioValue("glyph")]();

    if (glyphMask[0].checked && glyph) {
      glyph = Chibadge.coloredMask(glyph, '#' + glyphMaskColor.val());
    }

    Chibadge.build({
      size: badgeSize,
      background: background,
      glyph: glyph,
      glyphScale: parseFloat(glyphScale.val()),
      gloss: gloss[0].checked
    }, function(err, canvas) {
      if (renderId != renderIdCounter) return;
      badgeHolder.empty();
      if (!err) badgeHolder.append(canvas).trigger("badgechanged");
    });
  };

  deferredRequests.done(function() {
    exportButton.click(function() {
      alert("To export the badge as an image, load this page in Firefox, " +
            "right-click on the badge, and select \"Save Image As...\".");
    });

    // We used to use bootstrap's $.affix() for this, but it appears to be
    // buggy.
    $(window).on("scroll", function() {
      var shouldAffix = $(window).scrollTop() > origBadgeHolderTop
      badgeHolder.toggleClass("affix", shouldAffix);
    });

    startStateManager({
      onChange: function(state) {
        renderBadge();
        badgeLink.attr("href", "?" + $.param(state));
      }
    });
  });
});
</script>
