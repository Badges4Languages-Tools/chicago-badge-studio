<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.css">
<style>
.affix {
  top: 10px;
}

input.color {
  border: none;
  padding: 3px;
  margin-bottom: 10px;
}
</style>
<title>Chicago Badge Studio</title>
<div class="container">
  <h1>Chicago Badge Studio</h1>
  <div class="row">
    <div class="span4">
      <form>
        <fieldset>
          <h4>Background</h4>
          <label>Color</label>
          <input id="bg-color" class="color" value="9E300E">
          <label>Subtle Pattern</label>
          <select id="bg-subtlepattern">
            <option value="" selected>--</option>
          </select>
          <p class="muted"><small>Subtle Patterns are courtesy <a href="http://subtlepatterns.com/">subtlepatterns.com</a>, and are licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.</small></p>
          <label>URL</label>
          <input id="bg-url" type="text">
          <h4>Glyph</h4>
          <label>Noun</label>
          <select id="glyph-noun">
            <option value="" selected>--</option>
          </select>
          <p class="muted"><small>Nouns are courtesy <a href="http://nounproject.com/">nounproject.com</a>. Each noun has its own Creative Commons license.</small></p>
          <label>URL</label>
          <input id="glyph-url" type="text">
          <label>Scaling</label>
          <input id="glyph-scale" type="text" value="1.0">
          <label class="checkbox">
            <input id="glyph-mask" type="checkbox" checked> Apply mask color
          </label>
          <input id="glyph-mask-color" class="color" value="000000">
          <h4>Other Options</h4>
          <label class="checkbox">
            <input id="gloss" type="checkbox" checked> Glossy
          </label>
        </fieldset>
      </form>
    </div>
    <div class="span8">
      <div id="badge-holder">
        <p class="muted">Loading&hellip;</p>
      </div>
    </div>
  </div>
</div>
<script src="vendor/jscolor/jscolor.js"></script>
<script src="vendor/jquery.js"></script>
<script src="vendor/bootstrap/js/bootstrap.js"></script>
<script src="chibadge/chibadge.js"></script>
<script>
var BASE_SUBTLEPATTERN_URL = 'http://subtlepatterns.toolness.org/';
var BASE_NOUN_URL = 'http://nounproject.toolness.org/';

function isSafeUrl(str) {
  return /^https?:\/\//.test(str);
}

function img(src) {
  var img = document.createElement("img");
  img.setAttribute("src", src);
  return img;
}

function addFilenamesAsOptions(selectElement) {
  return function(textFile) {
    textFile.split('\n').forEach(function(filename) {
      if (!filename) return;
      $('<option></option>')
        .text(filename.split('.')[0].replace(/[_-]/g, ' '))
        .attr("value", filename)
        .appendTo(selectElement);
    });
  };
}

$(function() {
  var renderIdCounter = 0;
  var badgeHolder = $("#badge-holder");
  var bgColor = $("#bg-color");
  var bgSubtlepattern = $("#bg-subtlepattern");
  var bgUrl = $("#bg-url");
  var glyphNoun = $("#glyph-noun");
  var glyphUrl = $("#glyph-url");
  var glyphScale = $("#glyph-scale");
  var glyphMask = $("#glyph-mask");
  var glyphMaskColor = $("#glyph-mask-color");
  var gloss = $("#gloss");
  var badgeSize = badgeHolder.width() - 20;
  var renderBadge = function() {
    var renderId = ++renderIdCounter;
    var background;
    var glyph;

    if (isSafeUrl(bgUrl.val())) {
      background = img(bgUrl.val());
    } else if (bgSubtlepattern.val()) {
      background = img(BASE_SUBTLEPATTERN_URL + bgSubtlepattern.val());
    } else {
      background = '#' + bgColor.val();
    }

    if (isSafeUrl(glyphUrl.val())) {
      glyph = img(glyphUrl.val());
    } else if (glyphNoun.val()) {
      glyph = img(BASE_NOUN_URL + glyphNoun.val());
    }

    if (glyphMask[0].checked && glyph) {
      glyph = Chibadge.coloredMask(glyph, '#' + glyphMaskColor.val());
    }

    Chibadge.build({
      size: badgeSize,
      background: background,
      glyph: glyph,
      glyphScale: parseFloat(glyphScale.val()),
      gloss: gloss[0].checked
    }, function(err, canvas) {
      if (renderId != renderIdCounter) return;
      badgeHolder.empty();
      if (!err) badgeHolder.append(canvas);
    });
  };

  $.get('vendor/subtlepatterns.txt', addFilenamesAsOptions(bgSubtlepattern));
  $.get('vendor/nounproject.txt', addFilenamesAsOptions(glyphNoun));
  $(document.body).on("change", "input, select", renderBadge);
  badgeHolder.affix({offset: badgeHolder.offset().top});
  renderBadge();
});
</script>
